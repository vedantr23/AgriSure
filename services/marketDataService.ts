import { TickerData, MarketData } from '../types';

const initialTickerData: TickerData[] = [
    { symbol: 'SOYBEAN', expiry: '20NOV2025', price: 4280.00, changePercent: 0.12 },
    { symbol: 'MUSTARD', expiry: '20NOV2025', price: 5820.00, changePercent: 0.17 },
    { symbol: 'RAPESEED', expiry: '20NOV2025', price: 5930.00, changePercent: -0.25 },
    { symbol: 'GROUNDNUT', expiry: '19DEC2025', price: 6550.00, changePercent: 0.38 },
    { symbol: 'CASTOR SEED', expiry: '20NOV2025', price: 6761.00, changePercent: 0.03 },
    { symbol: 'DHANIYA', expiry: '19DEC2025', price: 8082.00, changePercent: -1.61 },
    { symbol: 'SESAME', expiry: '19DEC2025', price: 12550.00, changePercent: 0.40 },
    { symbol: 'LINSEED', expiry: '20NOV2025', price: 5530.00, changePercent: 0.18 },
];

const initialMarketData: MarketData[] = [
    {
        productName: 'Castor Seed',
        symbol: 'CASTOR',
        expiryDate: '20-Nov-2025',
        open: 6788.00,
        low: 6752.00,
        ltp: 6761.00,
        high: 6836.00,
        close: 6759.00,
        change: 2.00,
        changePercent: 0.03,
        atp: 6782.21,
        spotPrice: 6693.20,
        spotPriceDateTime: 'Oct 17 2025 | 03:12 PM',
        bestBuy: 6761.00,
        bestSell: 6767.00,
        oi: 28410,
    },
    {
        productName: 'Castor Seed',
        symbol: 'CASTOR',
        expiryDate: '19-Dec-2025',
        open: 6913.00,
        low: 6828.00,
        ltp: 6832.00,
        high: 6914.00,
        close: 6824.00,
        change: 8.00,
        changePercent: 0.12,
        atp: 6863.87,
        spotPrice: 6693.20,
        spotPriceDateTime: 'Oct 17 2025 | 03:12 PM',
        bestBuy: null,
        bestSell: 6839.00,
        oi: 5770,
    },
    {
        productName: 'Soybean',
        symbol: 'SOYBEAN',
        expiryDate: '20-Nov-2025',
        open: 4300.00,
        low: 4250.00,
        ltp: 4280.00,
        high: 4310.00,
        close: 4275.00,
        change: 5.00,
        changePercent: 0.12,
        atp: 4285.50,
        spotPrice: 4250.00,
        spotPriceDateTime: 'Oct 20 2025 | 03:30 PM',
        bestBuy: 4279.00,
        bestSell: 4281.00,
        oi: 35000,
    },
    {
        productName: 'Soybean',
        symbol: 'SOYBEAN',
        expiryDate: '19-Dec-2025',
        open: 4350.00,
        low: 4320.00,
        ltp: 4340.00,
        high: 4360.00,
        close: 4330.00,
        change: 10.00,
        changePercent: 0.23,
        atp: 4345.00,
        spotPrice: 4250.00,
        spotPriceDateTime: 'Oct 20 2025 | 03:30 PM',
        bestBuy: 4339.00,
        bestSell: 4341.00,
        oi: 21000,
    },
    {
        productName: 'Mustard Seed',
        symbol: 'MUSTARD',
        expiryDate: '20-Nov-2025',
        open: 5850.00,
        low: 5800.00,
        ltp: 5820.00,
        high: 5870.00,
        close: 5810.00,
        change: 10.00,
        changePercent: 0.17,
        atp: 5835.00,
        spotPrice: 5800.00,
        spotPriceDateTime: 'Oct 20 2025 | 03:30 PM',
        bestBuy: 5819.00,
        bestSell: 5821.00,
        oi: 18000,
    },
    {
        productName: 'Mustard Seed',
        symbol: 'MUSTARD',
        expiryDate: '19-Dec-2025',
        open: 5900.00,
        low: 5860.00,
        ltp: 5885.00,
        high: 5920.00,
        close: 5870.00,
        change: 15.00,
        changePercent: 0.26,
        atp: 5890.00,
        spotPrice: 5800.00,
        spotPriceDateTime: 'Oct 20 2025 | 03:30 PM',
        bestBuy: 5884.00,
        bestSell: 5886.00,
        oi: 12500,
    },
    {
        productName: 'Rapeseed',
        symbol: 'RAPESEED',
        expiryDate: '20-Nov-2025',
        open: 5950.00,
        low: 5900.00,
        ltp: 5930.00,
        high: 5960.00,
        close: 5945.00,
        change: -15.00,
        changePercent: -0.25,
        atp: 5935.00,
        spotPrice: 5900.00,
        spotPriceDateTime: 'Oct 20 2025 | 03:30 PM',
        bestBuy: 5929.00,
        bestSell: 5931.00,
        oi: 9800,
    },
    {
        productName: 'Rapeseed',
        symbol: 'RAPESEED',
        expiryDate: '19-Dec-2025',
        open: 6000.00,
        low: 5950.00,
        ltp: 5980.00,
        high: 6020.00,
        close: 5970.00,
        change: 10.00,
        changePercent: 0.17,
        atp: 5985.00,
        spotPrice: 5900.00,
        spotPriceDateTime: 'Oct 20 2025 | 03:30 PM',
        bestBuy: 5979.00,
        bestSell: 5981.00,
        oi: 7500,
    },
    {
        productName: 'Groundnut',
        symbol: 'GROUNDNUT',
        expiryDate: '20-Nov-2025',
        open: 6520.00,
        low: 6480.00,
        ltp: 6510.00,
        high: 6540.00,
        close: 6500.00,
        change: 10.00,
        changePercent: 0.15,
        atp: 6515.00,
        spotPrice: 6500.00,
        spotPriceDateTime: 'Oct 20 2025 | 03:30 PM',
        bestBuy: 6509.00,
        bestSell: 6511.00,
        oi: 15000,
    },
    {
        productName: 'Groundnut',
        symbol: 'GROUNDNUT',
        expiryDate: '19-Dec-2025',
        open: 6580.00,
        low: 6530.00,
        ltp: 6550.00,
        high: 6600.00,
        close: 6525.00,
        change: 25.00,
        changePercent: 0.38,
        atp: 6560.00,
        spotPrice: 6500.00,
        spotPriceDateTime: 'Oct 20 2025 | 03:30 PM',
        bestBuy: 6549.00,
        bestSell: 6551.00,
        oi: 11000,
    },
    {
        productName: 'Sesame Seed',
        symbol: 'SESAME',
        expiryDate: '20-Nov-2025',
        open: 12400.00,
        low: 12350.00,
        ltp: 12420.00,
        high: 12450.00,
        close: 12400.00,
        change: 20.00,
        changePercent: 0.16,
        atp: 12410.00,
        spotPrice: 12500.00,
        spotPriceDateTime: 'Oct 20 2025 | 03:30 PM',
        bestBuy: 12419.00,
        bestSell: 12421.00,
        oi: 8000,
    },
    {
        productName: 'Sesame Seed',
        symbol: 'SESAME',
        expiryDate: '19-Dec-2025',
        open: 12500.00,
        low: 12480.00,
        ltp: 12550.00,
        high: 12580.00,
        close: 12500.00,
        change: 50.00,
        changePercent: 0.40,
        atp: 12540.00,
        spotPrice: 12500.00,
        spotPriceDateTime: 'Oct 20 2025 | 03:30 PM',
        bestBuy: 12549.00,
        bestSell: 12551.00,
        oi: 6500,
    },
    {
        productName: 'Linseed',
        symbol: 'LINSEED',
        expiryDate: '20-Nov-2025',
        open: 5550.00,
        low: 5500.00,
        ltp: 5530.00,
        high: 5570.00,
        close: 5520.00,
        change: 10.00,
        changePercent: 0.18,
        atp: 5540.00,
        spotPrice: 5500.00,
        spotPriceDateTime: 'Oct 20 2025 | 03:30 PM',
        bestBuy: 5529.00,
        bestSell: 5531.00,
        oi: 4000,
    },
    {
        productName: 'Linseed',
        symbol: 'LINSEED',
        expiryDate: '19-Dec-2025',
        open: 5600.00,
        low: 5580.00,
        ltp: 5610.00,
        high: 5630.00,
        close: 5590.00,
        change: 20.00,
        changePercent: 0.36,
        atp: 5615.00,
        spotPrice: 5500.00,
        spotPriceDateTime: 'Oct 20 2025 | 03:30 PM',
        bestBuy: 5609.00,
        bestSell: 5611.00,
        oi: 2500,
    },
    {
        productName: 'Cotton Seed Oilcake',
        symbol: 'COCUDAKL',
        expiryDate: '19-Dec-2025',
        open: 2866.00,
        low: 2865.00,
        ltp: 2876.00,
        high: 2883.00,
        close: 2872.00,
        change: 4.00,
        changePercent: 0.14,
        atp: 2875.07,
        spotPrice: 3018.70,
        spotPriceDateTime: 'Oct 20 2025 | 03:21 PM',
        bestBuy: 2872.00,
        bestSell: 2876.00,
        oi: 16090,
    },
    {
        productName: 'Cotton Seed Oilcake',
        symbol: 'COCUDAKL',
        expiryDate: '20-Jan-2026',
        open: 2860.00,
        low: 2848.00,
        ltp: 2859.00,
        high: 2864.00,
        close: 2853.00,
        change: 6.00,
        changePercent: 0.21,
        atp: 2858.10,
        spotPrice: 3018.70,
        spotPriceDateTime: 'Oct 20 2025 | 03:21 PM',
        bestBuy: 2855.00,
        bestSell: 2864.00,
        oi: 2870,
    },
    {
        productName: 'Dhaniya',
        symbol: 'DHANIYA',
        expiryDate: '20-Nov-2025',
        open: 8040.00,
        low: 7968.00,
        ltp: 8002.00,
        high: 8070.00,
        close: 8090.00,
        change: -96.00,
        changePercent: -1.19,
        atp: 8028.56,
        spotPrice: 7842.30,
        spotPriceDateTime: 'Oct 20 2025 | 03:24 PM',
        bestBuy: 8000.00,
        bestSell: 8010.00,
        oi: 11665,
    },
    {
        productName: 'Dhaniya',
        symbol: 'DHANIYA',
        expiryDate: '19-Dec-2025',
        open: 8150.00,
        low: 8060.00,
        ltp: 8082.00,
        high: 8154.00,
        close: 8130.00,
        change: -132.00,
        changePercent: -1.61,
        atp: 8115.56,
        spotPrice: 7842.30,
        spotPriceDateTime: 'Oct 20 2025 | 03:24 PM',
        bestBuy: 8080.00,
        bestSell: 8084.00,
        oi: 7890,
    },
];


let intervalId: number | undefined;

let currentTickerData = [...initialTickerData];
let currentMarketData = [...initialMarketData];

const startRealtimeUpdates = (
    callback: (tickerData: TickerData[], marketData: MarketData[]) => void
) => {
    if (intervalId) {
        clearInterval(intervalId);
    }

    intervalId = window.setInterval(() => {
        // Update Market Data
        currentMarketData = currentMarketData.map(item => {
            const change = (Math.random() - 0.5) * (item.ltp * 0.005); // smaller fluctuation
            const newLtp = item.ltp + change;
            
            return {
                ...item,
                ltp: newLtp,
                change: newLtp - item.close,
                changePercent: ((newLtp - item.close) / item.close) * 100,
                high: Math.max(item.high, newLtp),
                low: Math.min(item.low, newLtp),
            };
        });
        
        // Update Ticker Data
        currentTickerData = currentTickerData.map(item => {
             const change = (Math.random() - 0.5) * (item.price * 0.01);
             const newPrice = item.price + change;
             const newChangePercent = item.changePercent + (change / item.price);
             return {
                ...item,
                price: newPrice,
                changePercent: newChangePercent,
             }
        });

        callback([...currentTickerData], [...currentMarketData]);
    }, 3000); // Update every 3 seconds
};

const stopRealtimeUpdates = () => {
    if (intervalId) {
        clearInterval(intervalId);
        intervalId = undefined;
    }
};

export const marketDataService = {
    getInitialData: () => ({
        tickerData: [...initialTickerData],
        marketData: [...initialMarketData],
    }),
    startRealtimeUpdates,
    stopRealtimeUpdates,
};